<!DOCTYPE html>
<html lang="en">
<head>
	<meta name="description" content="Alcohol recommendation app by the Alcohol Genome Project">
	<meta name="keywords" content="alcohol,beer,wine,whiskey,pandora,recommendation,suggestion,review,beeradvocate">
	<meta name="author" content="Evan Schwartz">
	<meta charset="utf-8">

	<title>
		Dionysus Beer Recommendations - The Alcohol Genome Project
	</title>

	<!-- jQuery -->
	<script src="http://code.jquery.com/jquery-1.9.1.min.js"></script>
	<script src="http://code.jquery.com/jquery-migrate-1.1.1.min.js"></script>

	<!-- boostrap -->

	<link type="text/css" rel="stylesheet" href="//cdn.jsdelivr.net/bootstrap/2.3.1/css/bootstrap.min.css" />
	<link type="text/css" rel="stylesheet" href="//cdn.jsdelivr.net/bootstrap/2.3.1/css/bootstrap.css" />
	<link type="text/css" rel="stylesheet" href="//cdn.jsdelivr.net/bootstrap/2.3.1/css/bootstrap-responsive.css" />
<link type="text/css" rel="stylesheet" href="//cdn.jsdelivr.net/bootstrap/2.3.1/css/bootstrap-responsive.min.css" />
	<script type="text/javascript" src="//cdn.jsdelivr.net/bootstrap/2.3.1/js/bootstrap-tooltip.js"></script>
	<script type="text/javascript" src="//cdn.jsdelivr.net/bootstrap/2.3.1/js/bootstrap-popover.js"></script>

	<script type="text/javascript" src="//cdn.jsdelivr.net/bootstrap/2.3.1/js/bootstrap.js"></script>
	<script type="text/javascript" src="//cdn.jsdelivr.net/bootstrap/2.3.1/js/bootstrap.min.js"></script>

<!-- 
	<script type="text/javascript" src="https://ws.areyouahuman.com/ws/script/7571a9ef9a71b873292246c50fe4a7a1ab5fa851"></script>
-->

<!-- Select2 -->
<link type="text/css" rel="stylesheet" href="//cdn.jsdelivr.net/select2/3.3.1/select2.css" />
<script type="text/javascript" src="//cdn.jsdelivr.net/select2/3.3.1/select2.js"></script>
<script type="text/javascript" src="//cdn.jsdelivr.net/select2/3.3.1/select2.min.js"></script>

<!-- json-to-table -->
<script type="text/javascript" src="./afshinm-Json-to-HTML-Table-281c16c/json-to-table.js"></script>

<!-- local CSS -->
<link href="dionysus.css" rel="stylesheet">
<link rel='shortcut icon' href='./favicon_32.ico' />

<script>
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-40674809-1', 'alcoholgenome.com');
ga('send', 'pageview');

</script>


<script>

function buildResultsTable (results) {


	var table = '<table id="search_results" class="table table-hover">' +
	'<thead>' + 
	'<tr>' + 
	'<th>Name</th>' +
	'<th>Brewery</th>' +
	'<th>Style</th>' +
	'<th>Odds You\'ll Love It</th>' +
	'<th></th>' +
	'</tr>' + 
	'</thead>' +
	'<tbody>';

	for (var r = 0; r < results.length; r++) {
		table += '<tr>' + 
		
		'<td><span class="explanation-btn">' + results[r].name + '</span></td>' + 
		'<td><span class="explanation-btn">' + results[r].brewery + '</span></td>' +
		'<td><span class="explanation-btn">' + results[r].style + '</span></td>' +
		'<td><span class="explanation-btn">' + results[r].score + "/10" + '</span></td>' +
		'<td style="display:none"> ' + results[r].explanation + '</td>' +
		// '<td> <button id="explanation-btn' + r + '" class="btn btn-mini btn-info btn-mini explanation-btn"><i class="icon-info-sign icon-white"></i></button> </td>' + 
		'<td> <button id="like' + r + '" class="btn btn-mini btn-info like-rec-btn"><i class="icon-thumbs-up icon-white"></i></button> </td>' + 
		'<td> <button class="btn btn-primary btn-mini purchase"><i class="icon-shopping-cart icon-white"></i></button> </td>' +
						'</tr>';
					}


					table += '</tbody></table>';

					return table;
				}

				function createMailToLink (search_query, results) {
					var mailto = "mailto: ?subject=Dionysus%20Beer%20Recommendations&body=";
					var body = "When%20you%20searched%20the%20Alcohol%20Genome%20Project%20for:%0d%0d";
					for (var s = 0; s < search_query.length; s++) {
						body += search_query[s] + ", ";
					}
					body = body.substring(0, body.length-2);
					body += "%0d%0d%0dThe Top Recommendations Were:%0d%0d";

					for (var r = 0; r < results.length; r++) {
						if (body.length >= 1000) {
							break;
						}

						var name = results[r].name;
						name = name.substring(name.indexOf('<b>') + 3);
						name = name.substring(0, name.indexOf('</b>'));
						name = encodeURI(name);
						var brewery = encodeURI(results[r].brewery);
						body += (r+1) + ".%20" + name + "%20-%20" + brewery;
						body += "%0d";
					}

					body += "%0dFind%20the%20full%20results%20at%20http%3A%2F%2Falcoholgenome.com";
					body = body.replace(/&amp;/g, '%26')
					mailto += body;
					return mailto;
				}


				function performSearch () {
					var search_query = $("#search").val(),
				// state = $('#state').val();
				to_send = {
					"search_items" : search_query,
					// "state": state
				};

				if (("#search-examples").length > 0){
				$("#search-examples").remove();
			}

				$.post('/search', to_send, function (response) {
					var new_results = response;
					if (new_results.length == undefined) {
						$("#results").removeClass("visible");
						$("#results").addClass("invisible");
					} else {
						results_table = buildResultsTable(response);
						$('#search_results').html(results_table);

						// $.each($('.explanation-btn'), function (index, value) {
						// 	var table = $("#search_results")[0];
						// 	$(value).popover({
						// 		"content": $(table.rows[index].cells[4]).text(),
						// 	"trigger": "hover"
						// 	});
						// });
						var table = $("#search_results")[0];
						
						$('.explanation-btn').popover({
							"content": (function() {
								var row_num = parseInt($(this).parent().parent().children().index($(this).parent()) + 1);
								var explanation = $(table.rows[row_num].cells[4]).text();
								return explanation;
							}),
							"trigger": "hover",
							"placement": "top"
						});

						
						$('.like-rec-btn').click(function () {
							$(this).addClass('btn-success disabled');
							var row_num = parseInt($(this).attr('id').substring(4)) + 1,
							beer_name = $(table.rows[row_num].cells[0]).text(),
							brewery = $(table.rows[row_num].cells[1]).text();
							var search_val = $("#search").select2("val"),beer_and_brewery = beer_name + " - " + brewery;
							beer_and_brewery = beer_and_brewery.replace('&amp;', '&');

							if (beer_and_brewery.charAt(beer_and_brewery.length) == '\s' || beer_and_brewery.charAt(beer_and_brewery.length) == '') {
								beer_and_brewery = beer_and_brewery.substring(0,beer_and_brewery.length);
							}
							search_val.push(beer_and_brewery);
							$("#search").select2("val", search_val);
							performSearch();
						});

						$(".purchase").click(function (){
							alert("We're sorry, this feature is under development.\n\nNevertheless, we've noted that you might be interested in being able to purchase recommended drinks from Dionysus or find where you can purchase them in your local area. We'll try to get this working as soon as we can!\n\n- The Alcohol Genome Project");
						});
						$("#results").removeClass("invisible");
						$("#results").addClass("visible");
						$("#email").attr("href", createMailToLink(search_query, new_results));
						// $('#search_results_input').val(search_query);

					}
				});

}



$(document).ready(function() {

			// create empty search bar
			// $("#search").prop("disabled", true);
			$('#search').select2({
				placeholder: 'Loading Beers... (we\'re loading up thousands of beers, give us a sec)',
				width: '100%'
			});


			// get beer list from server and populate search bar field
			$.get('/get_beer_list', function(response) {
				var beer_list = response;
				$.each(beer_list, function(index, value) { 
					value = value.replace('&amp;', '&');

					$('#search')
					.append($("<option></option>")
						.attr("value",value)
						.text(value)); 
				});
				$('#search').select2({
					placeholder: 'Type some of your favorite beers...',
					width: "100%",
					minimumInputLength: 3

				});

				var sponsored_beers = [
				'Samuel Adams Boston Lager - Boston Beer Company (Samuel Adams)',
				'Sierra Nevada Pale Ale - Sierra Nevada Brewing Co.',
				'Rampant Imperial IPA - New Belgium Brewing',
				'Obsidian Stout - Deschutes Brewery',
				'A Little Sumpin\' Sumpin\' Ale - Lagunitas Brewing Company'
				];
				function shuffle (o) {
				for(var j, x, i = o.length; i; j = parseInt(Math.random() * i), x = o[--i], o[i] = o[j], o[j] = x);
					return o;
			}
			sponsored_beers = shuffle(sponsored_beers);


				var examples_html = '<br>For example: ';
				for (var ex = 0; ex < 2; ex++) {
					// var ex_name = beer_list[Math.floor(Math.random() * beer_list.length)];
					var ex_name = sponsored_beers[ex];

					examples_html += '<button class="btn btn-small search-example">' + ex_name + '</button>   ';
					
				}
				$("#search-examples").html(examples_html);
				
				$(".search-example").click(function () {
					$(this).addClass("disabled");
					$("#search").select2("val", $(this).text());
							performSearch();
							
				});

			});


			// automatically send search bar selections to the server and display results
			$("#search").change(function () {
				performSearch();
			});

			// $("#emailform").submit(function() {
			// 	// $('#emailbutton').replaceWith('<form><div id="AYAH"></div><input type="submit"></form>');
			// 	alert($("#emailform").val().session_secret);

			// });




});

</script>

</head>
<body>
	<div class="navbar">
		<div class="navbar-inner">
			<!-- <div class="container vcentered"> -->
			<a class="brand vcentered" href="beer.html"><img src="./logo.png" alt="Dionysus - alcoholgenome.com" class="logo"></a>
			<ul class="nav">
				<li class="active"><a href="#">Beer</a></li>
				<li><a href="wine.html">Wine</a></li>
				<li><a href="whisky.html">Whisky</a></li>
				<li class="divider-vertical"></li>
				<li><a href="about.html">About</a></li>
				<li><a href='mailto:dionysus@alcoholgenome.com?subject=[Dionysus Contact] '>Contact</a></li>
			</ul>
			<!-- </div> -->
		</div>
	</div>

	<div class="page-header row-fluid">
		<span class="span8 offset2">
			<h2>Beer Recommendations</h2>
			...because life is too short for bad beer.
		</span>
	</div>

	<div class="row-fluid">
		<span class="span8 offset2">
			<div id="searchinstruct" class="lead"> Enter your favorite beers and we'll suggest others you'll love: </div>

			<select multiple id="search">
			</select>

			<div id="search-examples"></div>

		</span>
	</div>
	<br>

	<div id="results" class="invisible">
		<div class="row-fluid">

			<span class="span8 offset2">
				<span class="span4">
					<span class="lead">
						Our Suggestions: 
					</span>
				</span>


				<a id="email" href="" class="btn  btn-small pull-right"><i class="icon-envelope"></i> Email Top Results</a>


		</span>

	</div>
		<br>


	<div class="row-fluid">
		<span class="span8 offset2">

			<table id="search_results" class="table">
			</table>


		</span>
	</div>
</div>

</body>
</html>